<!doctype html>
<html>
  <head>
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Polverine Sensor Dashboard</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 20px;
        background: #f0f0f0;
        color: #333;
      }

      .container {
        max-width: 800px;
        margin: 0 auto;
        background: white;
        padding: 20px;
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      }

      h1 {
        text-align: center;
        color: #2c3e50;
        margin: 0;
        font-weight: 500;
      }

      .header-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 30px;
      }

      .device-id {
        font-size: 0.9em;
        color: #6c757d;
        margin-top: 5px;
        font-family: monospace;
      }

      .nav-link {
        display: inline-block;
        background: #6c757d;
        color: white;
        text-decoration: none;
        padding: 8px 16px;
        border-radius: 5px;
        font-size: 0.9em;
        transition: background 0.3s;
      }

      .nav-link:hover {
        background: #495057;
      }

      .sensor-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
      }

      .sensor-card {
        background: #f8f9fa;
        border: 1px solid #e9ecef;
        border-radius: 8px;
        padding: 20px;
      }

      .sensor-title {
        font-size: 1.2em;
        font-weight: 500;
        color: #495057;
        margin-bottom: 15px;
        text-align: center;
      }

      .metric {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 8px 0;
        border-bottom: 1px solid #e9ecef;
      }

      .metric:last-child {
        border-bottom: none;
      }

      .metric-label {
        font-weight: 500;
        color: #6c757d;
      }

      .metric-value {
        font-weight: 500;
        color: #2c3e50;
      }

      .unit {
        font-size: 0.8em;
        color: #6c757d;
      }

      .status {
        text-align: center;
        padding: 15px;
        border-radius: 5px;
        margin-top: 20px;
        font-weight: 500;
        font-size: 14px;
      }

      .status.good {
        background: #d4edda;
        color: #155724;
      }

      .status.warning {
        background: #fff3cd;
        color: #856404;
      }

      .status.error {
        background: #f8d7da;
        color: #721c24;
      }

      .refresh-btn {
        background: #007bff;
        color: white;
        border: none;
        padding: 12px 20px;
        border-radius: 5px;
        cursor: pointer;
        margin-top: 20px;
        width: 100%;
        font-size: 16px;
        transition: background 0.3s;
      }

      .refresh-btn:hover {
        background: #0056b3;
      }

      .last-update {
        text-align: center;
        color: #6c757d;
        font-size: 0.9em;
        margin-top: 15px;
      }

      @media (max-width: 768px) {
        body {
          margin: 10px;
        }

        .container {
          padding: 15px;
        }

        .header-row {
          flex-direction: column;
          gap: 15px;
          text-align: center;
        }

        .sensor-grid {
          grid-template-columns: 1fr;
          gap: 15px;
        }
      }

      @media (max-width: 480px) {
        .metric {
          flex-direction: column;
          align-items: flex-start;
          gap: 5px;
        }

        .metric-value {
          align-self: flex-end;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="header-row">
        <div>
          <h1>Polverine Sensor Dashboard</h1>
          <div class="device-id" id="device-id">Device ID: Loading...</div>
        </div>
        <a href="/config" class="nav-link">⚙️ Configuration</a>
      </div>

      <div class="sensor-grid">
        <div class="sensor-card">
          <div class="sensor-title">Environmental (BME690)</div>
          <div id="bme690-data">
            <div class="metric">
              <span class="metric-label">Temperature</span>
              <span class="metric-value" id="temperature"
                >--<span class="unit">°C</span></span
              >
            </div>
            <div class="metric">
              <span class="metric-label">Humidity</span>
              <span class="metric-value" id="humidity"
                >--<span class="unit">%</span></span
              >
            </div>
            <div class="metric">
              <span class="metric-label">Pressure</span>
              <span class="metric-value" id="pressure"
                >--<span class="unit">hPa</span></span
              >
            </div>
            <div class="metric">
              <span class="metric-label">Air Quality Index</span>
              <span class="metric-value" id="iaq">--</span>
            </div>
            <div class="metric">
              <span class="metric-label">CO₂ Equivalent</span>
              <span class="metric-value" id="co2"
                >--<span class="unit">ppm</span></span
              >
            </div>
            <div class="metric">
              <span class="metric-label">VOC Equivalent</span>
              <span class="metric-value" id="voc"
                >--<span class="unit">ppm</span></span
              >
            </div>
          </div>
        </div>

        <div class="sensor-card">
          <div class="sensor-title">Particulate Matter (BMV080)</div>
          <div id="bmv080-data">
            <div class="metric">
              <span class="metric-label">PM1.0</span>
              <span class="metric-value" id="pm1"
                >--<span class="unit">µg/m³</span></span
              >
            </div>
            <div class="metric">
              <span class="metric-label">PM2.5</span>
              <span class="metric-value" id="pm25"
                >--<span class="unit">µg/m³</span></span
              >
            </div>
            <div class="metric">
              <span class="metric-label">PM10</span>
              <span class="metric-value" id="pm10"
                >--<span class="unit">µg/m³</span></span
              >
            </div>
            <div class="metric">
              <span class="metric-label">Sensor Runtime</span>
              <span class="metric-value" id="runtime"
                >--<span class="unit">s</span></span
              >
            </div>
          </div>
        </div>
      </div>

      <div id="status-message" class="status good">
        Connecting to sensor data...
      </div>

      <button class="refresh-btn" onclick="refreshData()">Refresh Data</button>

      <div class="last-update" id="last-update">Last updated: Never</div>
    </div>

    <script>
      let lastUpdateTime = 0;

      function updateStatus(message, type = "good") {
        const statusEl = document.getElementById("status-message");
        statusEl.textContent = message;
        statusEl.className = "status " + type;
      }

      function formatValue(value, decimals = 1) {
        if (value === null || value === undefined || isNaN(value)) {
          return "--";
        }
        return Number(value).toFixed(decimals);
      }

      function updateSensorData(data) {
        const now = new Date();

        if (data.bme690) {
          const bme = data.bme690;
          document.getElementById("temperature").innerHTML =
            formatValue(bme.temperature, 1) + '<span class="unit">°C</span>';
          document.getElementById("humidity").innerHTML =
            formatValue(bme.humidity, 1) + '<span class="unit">%</span>';
          document.getElementById("pressure").innerHTML =
            formatValue(bme.pressure / 100, 1) +
            '<span class="unit">hPa</span>';
          document.getElementById("iaq").textContent = formatValue(bme.iaq, 0);
          document.getElementById("co2").innerHTML =
            formatValue(bme.co2_equivalent, 0) +
            '<span class="unit">ppm</span>';
          document.getElementById("voc").innerHTML =
            formatValue(bme.breath_voc_equivalent, 2) +
            '<span class="unit">ppm</span>';
        }

        if (data.bmv080) {
          const bmv = data.bmv080;
          document.getElementById("pm1").innerHTML =
            formatValue(bmv.pm1, 1) + '<span class="unit">µg/m³</span>';
          document.getElementById("pm25").innerHTML =
            formatValue(bmv.pm25, 1) + '<span class="unit">µg/m³</span>';
          document.getElementById("pm10").innerHTML =
            formatValue(bmv.pm10, 1) + '<span class="unit">µg/m³</span>';
          document.getElementById("runtime").innerHTML =
            formatValue(bmv.runtime, 0) + '<span class="unit">s</span>';
        }

        // Update device ID
        if (data.device_id) {
          document.getElementById("device-id").textContent =
            "Device ID: " + data.device_id;
        }

        const statusMessages = [];
        if (!data.status.bme690_available)
          statusMessages.push("BME690 offline");
        if (!data.status.bmv080_available)
          statusMessages.push("BMV080 offline");

        if (statusMessages.length === 0) {
          updateStatus("All sensors online", "good");
        } else if (statusMessages.length === 1) {
          updateStatus(statusMessages[0], "warning");
        } else {
          updateStatus("Multiple sensors offline", "error");
        }

        document.getElementById("last-update").textContent =
          "Last updated: " + now.toLocaleTimeString();
        lastUpdateTime = Date.now();
      }

      function refreshData() {
        fetch("/data")
          .then((response) => {
            if (!response.ok) {
              throw new Error("Network response was not ok");
            }
            return response.json();
          })
          .then((data) => {
            updateSensorData(data);
          })
          .catch((error) => {
            console.error("Error fetching data:", error);
            updateStatus("Error fetching sensor data", "error");
          });
      }

      function startAutoRefresh() {
        setInterval(() => {
          refreshData();
        }, 5000); // Refresh every 5 seconds
      }

      // Check if data is stale
      function checkDataFreshness() {
        setInterval(() => {
          if (lastUpdateTime > 0 && Date.now() - lastUpdateTime > 15000) {
            updateStatus("Data may be stale", "warning");
          }
        }, 10000); // Check every 10 seconds
      }

      // Initialize
      document.addEventListener("DOMContentLoaded", function () {
        refreshData();
        startAutoRefresh();
        checkDataFreshness();
      });
    </script>
  </body>
</html>
